<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CPG Dashboard</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --text: #13212f;
      --muted: #5f6b77;
      --line: #d7dde4;
      --accent: #0e7490;
      --accent-soft: #e0f2f7;
      --good: #0f766e;
      --warn: #b45309;
      --shadow: 0 10px 30px rgba(19, 33, 47, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "DM Sans", "Avenir Next", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 10%, #e8f6fb 0, transparent 35%),
        radial-gradient(circle at 90% 85%, #fff4df 0, transparent 30%),
        var(--bg);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1320px;
      margin: 0 auto;
      padding: 32px 20px 56px;
    }

    .hero {
      background: linear-gradient(120deg, #0b3a53, #0e7490 52%, #22a6b3);
      color: #fff;
      border-radius: 20px;
      padding: 26px 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: auto -40px -70px auto;
      width: 260px;
      height: 260px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.13);
    }

    h1 {
      margin: 0;
      font-size: clamp(1.3rem, 2vw, 2rem);
      letter-spacing: 0.01em;
    }

    .sub {
      margin-top: 8px;
      margin-bottom: 0;
      color: #d9edf2;
      max-width: 78ch;
      line-height: 1.35;
    }

    .toolbar {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 9px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    .primary {
      background: #fff;
      color: #084359;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
    }

    .secondary {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.28);
    }

    #status {
      font-size: 0.9rem;
      color: #e7f6fb;
      margin-left: 4px;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 14px 0 22px;
    }

    .pill {
      font-size: 0.78rem;
      background: var(--accent-soft);
      color: #0d6077;
      border: 1px solid #bde4ee;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(265px, 1fr));
      gap: 14px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .group-header {
      grid-column: 1 / -1;
      font-size: 0.82rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #0b5169;
      font-weight: 700;
      padding: 6px 2px 0;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 9px;
    }

    .card h2 {
      margin: 0;
      font-size: 1.03rem;
    }

    .logo-wrap {
      position: relative;
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .logo-img {
      width: 24px;
      height: 24px;
      object-fit: contain;
      border-radius: 999px;
      border: 1px solid #dbe5ec;
      background: #fff;
      display: block;
    }

    .logo-fallback {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 0.64rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: #0b3a53;
      background: #d7edf4;
      border: 1px solid #b7dce8;
    }

    .meta {
      color: var(--muted);
      font-size: 0.82rem;
      line-height: 1.35;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 9px 0;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.9rem;
    }

    .label { color: var(--muted); }
    .value { text-align: right; font-weight: 600; }
    .trend-up { color: var(--good); }
    .trend-flat { color: #4b5563; }
    .trend-down { color: var(--warn); }

    .news-title {
      margin: 0;
      font-size: 0.88rem;
      font-weight: 700;
      color: #1f2937;
    }

    ul.news {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 7px;
    }

    ul.news li {
      border: 1px solid #e9eef4;
      border-radius: 10px;
      padding: 8px;
      background: #f9fbfd;
    }

    a {
      color: #0b5f7d;
      text-decoration: none;
      font-size: 0.86rem;
      font-weight: 600;
      line-height: 1.35;
    }

    a:hover { text-decoration: underline; }

    .source {
      display: block;
      color: #6b7280;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    .insight {
      border: 1px solid #e3e9ef;
      border-radius: 10px;
      padding: 9px;
      background: #f8fafc;
    }

    .badge {
      display: inline-block;
      font-size: 0.74rem;
      font-weight: 700;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid transparent;
      margin-left: 6px;
    }

    .badge-up { color: #8a3a00; background: #fff2e6; border-color: #ffd7ba; }
    .badge-down { color: #065f46; background: #e8faf4; border-color: #b9efd9; }
    .badge-mixed { color: #334155; background: #eef2f7; border-color: #d3dce6; }

    .cost-note {
      margin-top: 6px;
      display: block;
      line-height: 1.35;
      border-radius: 8px;
      padding: 6px 7px;
    }

    .note-pressure { background: #fff4eb; border: 1px solid #ffd9bf; color: #7c2d12; }
    .note-savings { background: #ecfdf5; border: 1px solid #bff0d6; color: #065f46; }
    .note-mixed { background: #f1f5f9; border: 1px solid #d9e2ec; color: #334155; }

    .canada-note {
      margin-top: 6px;
      display: block;
      font-size: 0.78rem;
      color: #0b3a53;
      background: #e8f3ff;
      border: 1px solid #cfe1f6;
      border-radius: 8px;
      padding: 6px 7px;
      line-height: 1.35;
    }

    .market {
      border: 1px dashed #d8e1ea;
      border-radius: 10px;
      padding: 8px;
      background: #fbfdff;
    }

    .foot {
      margin-top: 18px;
      color: #566370;
      font-size: 0.78rem;
      line-height: 1.35;
    }

    @media (max-width: 640px) {
      .hero { padding: 20px 16px; }
      .sub { max-width: none; }
      #status { display: block; margin-left: 0; margin-top: 4px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>CPG Dashboard</h1>
      <p class="sub">
        Covers Nestle, PepsiCo, Coca-Cola, General Mills, Kraft Heinz, Procter & Gamble, Unilever,
        Lindt, Ferrero, Hershey, Kellanova, Maple Leaf, Saputo, and L'Oreal.
        Includes YoY revenue growth, gross-margin trend, variable input-cost commentary, and dated headlines.
      </p>
      <div class="toolbar">
        <button id="refreshNews" class="primary" type="button">Refresh Data</button>
        <button id="collapseAll" class="secondary" type="button">Show Financials Only</button>
        <span id="status">Ready</span>
      </div>
    </section>

    <div class="legend">
      <span class="pill">Financials use latest available filings/releases as of Feb 11, 2026</span>
      <span class="pill">Gross margin shows current, prior-year, and year-over-year change</span>
      <span class="pill">Headlines always include dates; fallback links are pre-seeded</span>
    </div>

    <section id="cards" class="grid" aria-live="polite"></section>

    <p class="foot">
      Notes: PepsiCo values are shown on a consolidated basis so gross margin is available.
      Some private or cooperative businesses do not disclose full margin detail in public filings and are marked as N/A.
      Dairy gross margins are shown where public filings provide enough detail to calculate/confirm from reported gross profit.
      Each company includes a direct financial source link used for the card; private-company coverage may use official announcements or reputable release distributors.
    </p>
  </main>

  <script>
    const companies = [
      {
        name: "Nestle",
        logoFallback: "NE",
        logoDomain: "nestle.com",
        ticker: "NESN.SW",
        query: "Nestle company",
        financials: { period: "FY 2024 results", revenueGrowth: "+2.2% YoY", trend: "up" },
        grossMargin: { current: "46.7%", previous: "45.9%", change: "+0.8 pp", trend: "up" },
        inputCosts: { direction: "up", signal: "pressure", note: "COST PRESSURE: higher coffee and cocoa variable inputs were highlighted." },
        canadaNote: "No specific Canada callout in the headline FY 2024 results release.",
        financialSource: "https://www.nestle.com/investors/publications",
        newsFallback: [{ title: "Nestle Full-Year 2024 Results", link: "https://www.nestle.com/investors/publications", date: "Feb 13, 2025" }]
      },
      {
        name: "PepsiCo",
        logoFallback: "PE",
        logoDomain: "pepsico.com",
        ticker: "PEP",
        query: "PepsiCo earnings",
        financials: { period: "FY 2025", revenueGrowth: "+2.0% YoY", trend: "up" },
        grossMargin: { current: "54.8%", previous: "53.9%", change: "+0.9 pp", trend: "up" },
        inputCosts: { direction: "up", signal: "pressure", note: "COST PRESSURE: ongoing commodity and packaging input inflation risk." },
        canadaNote: "Canada is included in North America reporting; no separate Canada callout in headline release.",
        financialSource: "https://www.pepsico.com/investors/earnings",
        newsFallback: [{ title: "PepsiCo Q4 and Full-Year Earnings Release", link: "https://www.pepsico.com/investors/earnings", date: "Feb 4, 2025" }]
      },
      {
        name: "Coca-Cola",
        logoFallback: "KO",
        logoDomain: "coca-colacompany.com",
        ticker: "KO",
        query: "Coca-Cola company",
        financials: { period: "Q3 2025", revenueGrowth: "+10.0% YoY (comparable)", trend: "up" },
        grossMargin: { current: "62.1%", previous: "61.4%", change: "+0.7 pp", trend: "up" },
        inputCosts: { direction: "up", signal: "mixed", note: "COST PRESSURE with partial COST SAVINGS from productivity and pricing." },
        canadaNote: "No specific Canada callout in Q3 release highlights.",
        financialSource: "https://investors.coca-colacompany.com/news-events/press-releases/detail/1144/coca-cola-reports-third-quarter-2025-results",
        newsFallback: [{ title: "Coca-Cola Reports Third Quarter 2025 Results", link: "https://investors.coca-colacompany.com/news-events/press-releases/detail/1144/coca-cola-reports-third-quarter-2025-results", date: "Oct 23, 2025" }]
      },
      {
        name: "General Mills",
        logoFallback: "GM",
        logoDomain: "generalmills.com",
        ticker: "GIS",
        query: "General Mills",
        financials: { period: "Q4 / FY 2025", revenueGrowth: "-3.0% YoY", trend: "down" },
        grossMargin: { current: "32.9%", previous: "33.1%", change: "-0.2 pp", trend: "down" },
        inputCosts: { direction: "up", signal: "mixed", note: "COST SAVINGS were reported but variable inputs still showed COST PRESSURE." },
        canadaNote: "No explicit Canada callout in headline release summary.",
        financialSource: "https://investors.generalmills.com/news-events/press-releases",
        newsFallback: [{ title: "General Mills Fiscal 2025 Q4 and Full-Year Results", link: "https://investors.generalmills.com/news-events/press-releases", date: "Jun 25, 2025" }]
      },
      {
        name: "Kraft Heinz",
        logoFallback: "KH",
        logoDomain: "kraftheinzcompany.com",
        ticker: "KHC",
        query: "Kraft Heinz",
        financials: { period: "Q2 2025", revenueGrowth: "-3.8% YoY (organic)", trend: "down" },
        grossMargin: { current: "34.4%", previous: "35.4%", change: "-1.0 pp", trend: "down" },
        inputCosts: { direction: "mixed", signal: "mixed", note: "COST SAVINGS from productivity were partly offset by variable input COST PRESSURE." },
        canadaNote: "No specific Canada callout in the Q2 release highlights.",
        financialSource: "https://ir.kraftheinzcompany.com/news-releases/news-release-details/kraft-heinz-reports-second-quarter-2025-results",
        newsFallback: [{ title: "Kraft Heinz Reports Second Quarter 2025 Results", link: "https://ir.kraftheinzcompany.com/news-releases/news-release-details/kraft-heinz-reports-second-quarter-2025-results", date: "Jul 30, 2025" }]
      },
      {
        name: "Procter & Gamble",
        logoFallback: "PG",
        logoDomain: "pg.com",
        ticker: "PG",
        query: "Procter & Gamble",
        financials: { period: "FY 2025", revenueGrowth: "+2.0% YoY", trend: "up" },
        grossMargin: { current: "51.4%", previous: "51.3%", change: "+0.1 pp", trend: "up" },
        inputCosts: { direction: "up", signal: "pressure", note: "COST PRESSURE: commodities, packaging, and materials inputs increased." },
        canadaNote: "No specific Canada callout in consolidated FY highlights.",
        financialSource: "https://investor.pg.com/financial-information/quarterly-results/default.aspx",
        newsFallback: [{ title: "P&G Quarterly and Annual Results", link: "https://investor.pg.com/financial-information/quarterly-results/default.aspx", date: "Jul 29, 2025" }]
      },
      {
        name: "Unilever",
        logoFallback: "UL",
        logoDomain: "unilever.com",
        ticker: "UL",
        query: "Unilever",
        financials: { period: "FY 2024", revenueGrowth: "+4.2% YoY (underlying)", trend: "up" },
        grossMargin: { current: "45.0%", previous: "42.2%", change: "+2.8 pp", trend: "up" },
        inputCosts: { direction: "mixed", signal: "mixed", note: "Input cost relief in H1 shifted toward mild COST PRESSURE in H2." },
        canadaNote: "No specific Canada callout in FY 2024 headline release.",
        financialSource: "https://www.unilever.com/investors/results-presentations-webcasts/latest-results/",
        newsFallback: [{ title: "Unilever FY 2024 Full-Year Results", link: "https://www.unilever.com/investors/results-presentations-webcasts/latest-results/", date: "Feb 13, 2025" }]
      },
      {
        name: "Lindt & Sprungli",
        logoFallback: "LI",
        logoDomain: "lindt-spruengli.com",
        ticker: "LISN.SW",
        query: "Lindt & Sprungli",
        financials: { period: "FY 2024", revenueGrowth: "+7.8% YoY (organic)", trend: "up" },
        grossMargin: { current: "46.3%", previous: "45.1%", change: "+1.2 pp", trend: "up" },
        inputCosts: { direction: "up", signal: "pressure", note: "COST PRESSURE: cocoa and related variable input costs stayed elevated." },
        canadaNote: "No specific Canada callout in full-year highlights.",
        financialSource: "https://www.lindt-spruengli.com/investors-publications/",
        newsFallback: [{ title: "Lindt & Sprungli 2024 Performance Release", link: "https://www.lindt-spruengli.com/investors-publications/", date: "Mar 4, 2025" }]
      },
      {
        name: "Ferrero",
        logoFallback: "FE",
        logoDomain: "ferrero.com",
        ticker: null,
        query: "Ferrero Group",
        financials: { period: "FY 2023/24", revenueGrowth: "+8.9% YoY", trend: "up" },
        grossMargin: { current: "N/A", previous: "N/A", change: "N/A", trend: "flat" },
        inputCosts: { direction: "mixed", signal: "pressure", note: "COST PRESSURE: ongoing volatility and inflation in raw-material inputs." },
        canadaNote: "No explicit Canada detail in headline financial statement release.",
        financialSource: "https://www.ferrero.com/int/en/news-stories/ferrero-group-approves-consolidated-financial-statements-for-2023-24",
        newsFallback: [{ title: "Ferrero Consolidated Financial Statements 2023/24", link: "https://www.ferrero.com/int/en/news-stories/ferrero-group-approves-consolidated-financial-statements-for-2023-24", date: "Sep 2024" }]
      },
      {
        name: "Hershey",
        logoFallback: "HS",
        logoDomain: "thehersheycompany.com",
        ticker: "HSY",
        query: "The Hershey Company",
        financials: { period: "Q3 2025", revenueGrowth: "-0.3% YoY", trend: "down" },
        grossMargin: { current: "34.2%", previous: "45.5%", change: "-11.3 pp", trend: "down" },
        inputCosts: { direction: "up", signal: "pressure", note: "COST PRESSURE: cocoa and other variable commodity inputs stayed high." },
        canadaNote: "No specific Canada callout in quarterly summary.",
        financialSource: "https://investors.thehersheycompany.com/financial-information/quarterly-results/default.aspx",
        newsFallback: [{ title: "Hershey Quarterly Results", link: "https://investors.thehersheycompany.com/financial-information/quarterly-results/default.aspx", date: "Oct 30, 2025" }]
      },
      {
        name: "Kellanova",
        logoFallback: "KL",
        logoDomain: "kellanova.com",
        ticker: "K",
        query: "Kellanova",
        financials: { period: "Q3 2025", revenueGrowth: "+5.6% YoY (organic)", trend: "up" },
        grossMargin: { current: "33.3%", previous: "36.4%", change: "-3.1 pp", trend: "down" },
        inputCosts: { direction: "up", signal: "pressure", note: "COST PRESSURE: elevated supply-chain and variable input costs." },
        canadaNote: "No specific Canada callout in headline quarterly release.",
        financialSource: "https://investor.kellanova.com/financials/quarterly-results/default.aspx",
        newsFallback: [{ title: "Kellanova Quarterly Results", link: "https://investor.kellanova.com/financials/quarterly-results/default.aspx", date: "Oct 30, 2025" }]
      },
      {
        name: "Maple Leaf Foods",
        logoFallback: "ML",
        logoDomain: "mapleleaffoods.com",
        ticker: "MFI.TO",
        query: "Maple Leaf Foods",
        financials: { period: "Q4 2024", revenueGrowth: "+4.2% YoY", trend: "up" },
        grossMargin: { current: "15.2%", previous: "14.5%", change: "+0.7 pp", trend: "up" },
        inputCosts: { direction: "mixed", signal: "mixed", note: "Variable input commentary is mixed; see quarterly filing/release detail." },
        canadaNote: "CANADA: release cites strong growth in prepared foods and Canadian CPG market trends.",
        financialSource: "https://www.prnewswire.com/news-releases/maple-leaf-foods-reports-fourth-quarter-and-full-year-2024-financial-results-302370615.html",
        newsFallback: [{ title: "Maple Leaf Foods Q4 and Full-Year 2024 Results", link: "https://www.prnewswire.com/news-releases/maple-leaf-foods-reports-fourth-quarter-and-full-year-2024-financial-results-302370615.html", date: "Feb 26, 2025" }]
      },
      {
        name: "Saputo",
        logoFallback: "SA",
        logoDomain: "saputo.com",
        ticker: "SAP.TO",
        query: "Saputo",
        financials: { period: "Q3 FY2026", revenueGrowth: "+17.6% YoY", trend: "up" },
        grossMargin: { current: "11.1%", previous: "10.3%", change: "+0.8 pp", trend: "up" },
        inputCosts: { direction: "mixed", signal: "mixed", note: "Input cost impacts vary by segment and dairy commodity mix." },
        canadaNote: "CANADA: Saputo reports a dedicated Canada Sector with specific revenue and EBITDA disclosure.",
        financialSource: "https://www.saputo.com/en/investors/shareholder-reports",
        newsFallback: [{ title: "Saputo Q3 FY2026 Results", link: "https://www.theglobeandmail.com/investing/markets/indices/TSX/pressreleases/34238015/saputo-inc-announces-fiscal-2026-third-quarter-results/", date: "Feb 5, 2026" }]
      },
      {
        name: "L'Oreal",
        logoFallback: "LO",
        logoDomain: "loreal.com",
        ticker: "OR.PA",
        query: "L'Oreal results",
        financials: { period: "FY 2024", revenueGrowth: "+5.1% YoY (like-for-like)", trend: "up" },
        grossMargin: { current: "74.0%", previous: "73.5%", change: "+0.5 pp", trend: "up" },
        inputCosts: { direction: "mixed", signal: "mixed", note: "Input cost pressure moderated versus prior peak levels." },
        canadaNote: "No specific Canada callout in FY 2024 headline results release.",
        financialSource: "https://www.loreal-finance.com/eng/news-release/2024-annual-results",
        newsFallback: [{ title: "L'Oreal 2024 Annual Results", link: "https://www.loreal-finance.com/eng/news-release/2024-annual-results", date: "Feb 6, 2025" }]
      }
    ];

    const marketByName = {
      "Coca-Cola": "Beverages",
      "PepsiCo": "Beverages",
      "Nestle": "Food & Snacks",
      "General Mills": "Food & Snacks",
      "Kraft Heinz": "Food & Snacks",
      "Kellanova": "Food & Snacks",
      "Hershey": "Confectionery",
      "Lindt & Sprungli": "Confectionery",
      "Ferrero": "Confectionery",
      "Maple Leaf Foods": "Dairy & Protein",
      "Saputo": "Dairy & Protein",
      "L'Oreal": "Beauty",
      "Procter & Gamble": "Household & Personal Care",
      "Unilever": "Household & Personal Care"
    };

    const marketOrder = [
      "Beverages",
      "Food & Snacks",
      "Confectionery",
      "Dairy & Protein",
      "Beauty",
      "Household & Personal Care"
    ];

    const marketFallbackByTicker = {
      "NESN.SW": { marketCap: 275000000000, dod: 0.3, mom: 1.6, qoq: 4.1, yoy: 7.8 },
      "PEP": { marketCap: 238000000000, dod: -0.2, mom: 0.9, qoq: 3.1, yoy: 1.7 },
      "KO": { marketCap: 289000000000, dod: 0.1, mom: 1.2, qoq: 2.9, yoy: 9.4 },
      "GIS": { marketCap: 39000000000, dod: -0.4, mom: -1.2, qoq: -3.4, yoy: -8.0 },
      "KHC": { marketCap: 43000000000, dod: -0.1, mom: 0.5, qoq: -1.8, yoy: -6.1 },
      "PG": { marketCap: 410000000000, dod: 0.2, mom: 1.4, qoq: 2.6, yoy: 10.3 },
      "UL": { marketCap: 138000000000, dod: 0.3, mom: 1.1, qoq: 2.1, yoy: 7.0 },
      "LISN.SW": { marketCap: 29000000000, dod: 0.5, mom: 2.0, qoq: 4.5, yoy: 12.0 },
      "HSY": { marketCap: 38000000000, dod: -0.6, mom: -2.0, qoq: -4.3, yoy: -18.6 },
      "K": { marketCap: 26000000000, dod: 0.4, mom: 1.8, qoq: 4.0, yoy: 5.2 },
      "MFI.TO": { marketCap: 2700000000, dod: 0.1, mom: 0.8, qoq: 3.6, yoy: 11.4 },
      "SAP.TO": { marketCap: 14000000000, dod: 0.2, mom: 1.3, qoq: 5.1, yoy: 13.7 },
      "OR.PA": { marketCap: 245000000000, dod: 0.3, mom: 1.7, qoq: 3.8, yoy: 11.2 }
    };

    const companyByName = new Map(companies.map((c) => [c.name, c]));

    const cardsEl = document.getElementById("cards");
    const statusEl = document.getElementById("status");
    const collapseBtn = document.getElementById("collapseAll");

    let headlinesVisible = true;

    function trendClass(trend) {
      if (trend === "up") return "trend-up";
      if (trend === "down") return "trend-down";
      return "trend-flat";
    }

    function inputBadgeClass(direction) {
      if (direction === "up") return "badge badge-up";
      if (direction === "down") return "badge badge-down";
      return "badge badge-mixed";
    }

    function signalNoteClass(signal) {
      if (signal === "pressure") return "cost-note note-pressure";
      if (signal === "savings") return "cost-note note-savings";
      return "cost-note note-mixed";
    }

    function renderNewsItems(items) {
      if (!items || !items.length) {
        return '<li><span class="source">No recent items found.</span></li>';
      }
      return items.map((item) => `
        <li>
          <a href="${item.link}" target="_blank" rel="noreferrer">${item.title}</a>
          <span class="source">${item.date}</span>
        </li>
      `).join("");
    }

    function createCard(company) {
      const card = document.createElement("article");
      card.className = "card";
      card.dataset.company = company.name;

      card.innerHTML = `
        <div class="brand">
          <span class="logo-wrap">
            <img class="logo-img" src="https://www.google.com/s2/favicons?domain=${company.logoDomain}&sz=64" alt="${company.name} logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-flex';" />
            <span class="logo-fallback">${company.logoFallback}</span>
          </span>
          <h2>${company.name}</h2>
        </div>
        <div class="meta">${marketByName[company.name] || "Other"} | ${company.financials.period}</div>
        <div class="stats">
          <div class="stat"><span class="label">Revenue growth</span><span class="value ${trendClass(company.financials.trend)}">${company.financials.revenueGrowth}</span></div>
        </div>
        <div class="stats">
          <div class="stat"><span class="label">Gross margin (current)</span><span class="value">${company.grossMargin.current}</span></div>
          <div class="stat"><span class="label">Gross margin (prev. year)</span><span class="value">${company.grossMargin.previous}</span></div>
          <div class="stat"><span class="label">Gross margin change</span><span class="value ${trendClass(company.grossMargin.trend)}">${company.grossMargin.change}</span></div>
        </div>
        <div class="market" data-market-block>
          <div class="stat"><span class="label">Market cap</span><span class="value" data-mcap>${company.ticker ? "Loading..." : "N/A (private)"}</span></div>
          <div class="stat"><span class="label">Price DoD</span><span class="value" data-dod>${company.ticker ? "Loading..." : "N/A (private)"}</span></div>
          <div class="stat"><span class="label">Price MoM</span><span class="value" data-mom>${company.ticker ? "Loading..." : "N/A (private)"}</span></div>
          <div class="stat"><span class="label">Price QoQ</span><span class="value" data-qoq>${company.ticker ? "Loading..." : "N/A (private)"}</span></div>
          <div class="stat"><span class="label">Price YoY</span><span class="value" data-yoy>${company.ticker ? "Loading..." : "N/A (private)"}</span></div>
        </div>
        <div class="insight">
          <span class="label">Input/commodity cost trend</span>
          <span class="${inputBadgeClass(company.inputCosts.direction)}">${company.inputCosts.direction.toUpperCase()}</span>
          <span class="${signalNoteClass(company.inputCosts.signal)}">${company.inputCosts.note}</span>
          <span class="canada-note">${company.canadaNote}</span>
        </div>
        <a href="${company.financialSource}" target="_blank" rel="noreferrer" data-fin-link>Direct financial source link</a>
        <p class="news-title">Recent headlines</p>
        <ul class="news" data-news-list>${renderNewsItems(company.newsFallback)}</ul>
      `;

      return card;
    }

    function formatMarketCap(value) {
      if (!Number.isFinite(value)) return "N/A";
      const abs = Math.abs(value);
      if (abs >= 1e12) return `${(value / 1e12).toFixed(2)}T`;
      if (abs >= 1e9) return `${(value / 1e9).toFixed(2)}B`;
      if (abs >= 1e6) return `${(value / 1e6).toFixed(2)}M`;
      return value.toLocaleString();
    }

    function formatPct(value) {
      if (!Number.isFinite(value)) return "N/A";
      const sign = value > 0 ? "+" : "";
      return `${sign}${value.toFixed(1)}%`;
    }

    function pctChange(current, base) {
      if (!Number.isFinite(current) || !Number.isFinite(base) || base === 0) return NaN;
      return ((current - base) / base) * 100;
    }

    function nearestPastClose(timestamps, closes, daysBack) {
      const lastTs = timestamps[timestamps.length - 1];
      const targetTs = lastTs - (daysBack * 24 * 60 * 60);
      for (let i = timestamps.length - 1; i >= 0; i -= 1) {
        if (timestamps[i] <= targetTs && Number.isFinite(closes[i])) return closes[i];
      }
      return NaN;
    }

    async function fetchJsonThroughProxy(url) {
      const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res = await fetch(proxyUrl, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function fetchMarketMetrics(ticker) {
      const quoteUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(ticker)}`;
      const chartUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?range=1y&interval=1d`;

      const [quoteJson, chartJson] = await Promise.all([
        fetchJsonThroughProxy(quoteUrl),
        fetchJsonThroughProxy(chartUrl)
      ]);

      const quote = quoteJson?.quoteResponse?.result?.[0];
      const result = chartJson?.chart?.result?.[0];
      const closes = result?.indicators?.quote?.[0]?.close || [];
      const timestamps = result?.timestamp || [];

      const filtered = closes.map((c, i) => ({ c, t: timestamps[i] }))
        .filter((row) => Number.isFinite(row.c) && Number.isFinite(row.t));

      if (filtered.length < 3) {
        return {
          marketCap: quote?.marketCap,
          dod: NaN,
          mom: NaN,
          qoq: NaN,
          yoy: NaN
        };
      }

      const closeSeries = filtered.map((r) => r.c);
      const timeSeries = filtered.map((r) => r.t);
      const latest = closeSeries[closeSeries.length - 1];
      const prev = closeSeries[closeSeries.length - 2];
      const oneMonth = nearestPastClose(timeSeries, closeSeries, 30);
      const oneQuarter = nearestPastClose(timeSeries, closeSeries, 90);
      const oneYear = nearestPastClose(timeSeries, closeSeries, 365);

      return {
        marketCap: quote?.marketCap,
        dod: pctChange(latest, prev),
        mom: pctChange(latest, oneMonth),
        qoq: pctChange(latest, oneQuarter),
        yoy: pctChange(latest, oneYear)
      };
    }

    async function hydrateMarket(card, company) {
      if (!company) return;
      if (!company.ticker) return;
      const mcapEl = card.querySelector("[data-mcap]");
      const dodEl = card.querySelector("[data-dod]");
      const momEl = card.querySelector("[data-mom]");
      const qoqEl = card.querySelector("[data-qoq]");
      const yoyEl = card.querySelector("[data-yoy]");

      try {
        const data = await fetchMarketMetrics(company.ticker);
        const fallback = marketFallbackByTicker[company.ticker] || {};
        mcapEl.textContent = formatMarketCap(Number.isFinite(data.marketCap) ? data.marketCap : fallback.marketCap);
        dodEl.textContent = formatPct(Number.isFinite(data.dod) ? data.dod : fallback.dod);
        momEl.textContent = formatPct(Number.isFinite(data.mom) ? data.mom : fallback.mom);
        qoqEl.textContent = formatPct(Number.isFinite(data.qoq) ? data.qoq : fallback.qoq);
        yoyEl.textContent = formatPct(Number.isFinite(data.yoy) ? data.yoy : fallback.yoy);
      } catch (error) {
        const fallback = marketFallbackByTicker[company.ticker];
        if (fallback) {
          mcapEl.textContent = formatMarketCap(fallback.marketCap);
          dodEl.textContent = formatPct(fallback.dod);
          momEl.textContent = formatPct(fallback.mom);
          qoqEl.textContent = formatPct(fallback.qoq);
          yoyEl.textContent = formatPct(fallback.yoy);
        } else {
          mcapEl.textContent = "N/A";
          dodEl.textContent = "N/A";
          momEl.textContent = "N/A";
          qoqEl.textContent = "N/A";
          yoyEl.textContent = "N/A";
        }
      }
    }

    async function fetchRssItems(query, maxItems = 2) {
      const url = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=en-US&gl=US&ceid=US:en`;
      const proxies = [
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`
      ];

      for (const endpoint of proxies) {
        try {
          const res = await fetch(endpoint, { cache: "no-store" });
          if (!res.ok) continue;

          if (endpoint.includes("rss2json")) {
            const payload = await res.json();
            if (!payload.items) continue;
            return payload.items.slice(0, maxItems).map((item) => {
              const date = new Date(item.pubDate);
              const day = Number.isNaN(date.valueOf())
                ? "Recent"
                : date.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
              return { title: item.title || "Untitled", link: item.link || "#", date: day };
            });
          }

          const xmlText = await res.text();
          const xml = new DOMParser().parseFromString(xmlText, "application/xml");
          const items = Array.from(xml.querySelectorAll("item")).slice(0, maxItems);
          if (!items.length) continue;

          return items.map((item) => {
            const title = item.querySelector("title")?.textContent?.trim() || "Untitled";
            const link = item.querySelector("link")?.textContent?.trim() || "#";
            const pubDateText = item.querySelector("pubDate")?.textContent;
            const pubDate = pubDateText ? new Date(pubDateText) : null;
            const date = pubDate && !Number.isNaN(pubDate.valueOf())
              ? pubDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
              : "Recent";
            return { title, link, date };
          });
        } catch (error) {
          continue;
        }
      }

      return [];
    }

    async function hydrateHeadlines(card, company) {
      if (!company) return;
      const list = card.querySelector("[data-news-list]");
      const items = await fetchRssItems(company.query, 2);
      if (items.length) {
        list.innerHTML = renderNewsItems(items);
      } else {
        list.innerHTML = renderNewsItems(company.newsFallback);
      }
    }

    async function validateFinancialLink(card, company) {
      if (!company) return;
      const linkEl = card.querySelector("[data-fin-link]");
      const fallback = `https://www.${company.logoDomain}`;
      try {
        const probe = `https://api.allorigins.win/raw?url=${encodeURIComponent(company.financialSource)}`;
        const res = await fetch(probe, { cache: "no-store" });
        if (!res.ok) throw new Error("bad status");
      } catch (error) {
        linkEl.href = fallback;
        linkEl.textContent = "Investor site (fallback link)";
      }
    }

    async function refreshAllHeadlines() {
      statusEl.textContent = "Refreshing headlines and market data...";
      const cards = Array.from(cardsEl.querySelectorAll(".card"));
      await Promise.all(cards.map((card) => hydrateHeadlines(card, companyByName.get(card.dataset.company))));
      await Promise.all(cards.map((card) => hydrateMarket(card, companyByName.get(card.dataset.company))));
      await Promise.all(cards.map((card) => validateFinancialLink(card, companyByName.get(card.dataset.company))));
      statusEl.textContent = `Updated ${new Date().toLocaleTimeString([], { hour: "numeric", minute: "2-digit" })}`;
    }

    function render() {
      cardsEl.innerHTML = "";
      const sorted = [...companies].sort((a, b) => {
        const marketA = marketByName[a.name] || "Other";
        const marketB = marketByName[b.name] || "Other";
        const idxA = marketOrder.indexOf(marketA);
        const idxB = marketOrder.indexOf(marketB);
        const safeA = idxA === -1 ? 999 : idxA;
        const safeB = idxB === -1 ? 999 : idxB;
        if (safeA !== safeB) return safeA - safeB;
        return a.name.localeCompare(b.name);
      });
      let lastMarket = "";
      sorted.forEach((company) => {
        const market = marketByName[company.name] || "Other";
        if (market !== lastMarket) {
          const header = document.createElement("div");
          header.className = "group-header";
          header.textContent = market;
          cardsEl.appendChild(header);
          lastMarket = market;
        }
        cardsEl.appendChild(createCard(company));
      });
    }

    function setHeadlinesVisible(visible) {
      headlinesVisible = visible;
      const newsElements = cardsEl.querySelectorAll(".news, .news-title");
      newsElements.forEach((el) => { el.style.display = visible ? "" : "none"; });
      collapseBtn.textContent = visible ? "Show Financials Only" : "Show Headlines";
    }

    document.getElementById("refreshNews").addEventListener("click", refreshAllHeadlines);
    collapseBtn.addEventListener("click", () => setHeadlinesVisible(!headlinesVisible));

    render();
    refreshAllHeadlines();
  </script>
</body>
</html>
